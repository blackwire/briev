'use strict';

const $ = require('jquery.js'),
      electron = require('electron');

exports.init = function(container)
{
    let clip = $('#clip', container),
        paste = $('#paste', container);

    // handle drag-drop behavior
    // (disallow drag and drop anywhere but the actual clipboard icon)
    // ----------------------------------------------------------------------------------
        clip.get(0).addEventListener('dragover', function(event)
        {
            event.stopPropagation();
            event.preventDefault();

            if (clip.hasClass('waiting'))
            { event.dataTransfer.dropEffect = 'copy'; }
        },
        false);

        clip.get(0).addEventListener('drop', function(event)
        {
            event.stopPropagation();
            event.preventDefault();

            if (clip.hasClass('waiting'))
            {
                let files = event.dataTransfer.files,
                    file = files[0],
                    reader = new FileReader();

                if (paste.data('dragging'))
                {
                    let data = JSON.parse(localStorage.clipboard)[paste.data('clipboardIndex')];
                    save(data[data.length - 1]);
                    toggle(clip);
                    return;
                }

                let binary = file.slice(0, file.size);

                reader.onloadend = function(event)
                {
                    if (event.target.readyState === FileReader.DONE)
                    { save(event.target.result); toggle(clip); }
                }

                reader.readAsBinaryString(binary);
            }
        },
        false);
    // ----------------------------------------------------------------------------------
}

function save(text)
{ electron.clipboard.writeText(text); }

function toggle(clip)
{
    clip.toggleClass('copied')
        .toggleClass('waiting');

    if (clip.hasClass('copied'))
    {
        setTimeout(function()
        { toggle(clip); }, 1000);
    }
}